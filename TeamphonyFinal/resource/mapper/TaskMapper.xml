<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="teamphony.store.mapper.TaskMapper">

<insert id="insertAssignment" parameterType="task">
		<selectKey resultType="int" keyProperty="taskId" order="BEFORE">
			SELECT TASK_TB_ID_SEQ.NEXTVAL
			FROM DUAL
		</selectKey>
			INSERT
			INTO TASK_TB
			(
				ID,
				TITLE,
				CONTENTS,
				DEADLINE,
				FLAG,
				EVALUATIONPERIODSTART,
				EVALUATIONPERIODEND,
				POINT
			)
			VALUES
			(
				#{taskId},
				#{title},
				#{contents, jdbcType=VARCHAR},
				#{deadline, jdbcType=VARCHAR},
				#{flag, jdbcType=INTEGER},
				#{evaluationPeriodStart, jdbcType=VARCHAR},
				#{evaluationPeriodEnd, jdbcType=VARCHAR},
				#{point, jdbcType=INTEGER}
			)
	</insert>  
	<insert id="insertTaskMember">
			INSERT
			INTO TASKMEMBER
			(
				ASSIGNMENTID,
				MEMBERID
			)
			VALUES
			(	#{taskId},
				#{memberId }
			)
	</insert>
	
	<insert id="insertSubmission" parameterType="task">
		<selectKey resultType="int" keyProperty="taskId" order="BEFORE">
			SELECT TASK_TB_ID_SEQ.NEXTVAL
			FROM DUAL
		</selectKey>
			INSERT
			INTO TASK_TB
			(
				ID,
				TITLE,
				CONTENTS,
				FLAG,
				POINT
			)
			VALUES
			(
				#{taskId},
				#{title},
				#{contents, jdbcType=VARCHAR},
				#{flag, jdbcType=INTEGER},
				#{point, jdbcType=INTEGER}
			)
	</insert>  
	

	<insert id="insertTaskFile" parameterType="taskFile">
			INSERT INTO
				TASKFILE_TB
				(
					SUBMISSIONID
					,FILEPATH
				)
				VALUES
				(
					#{submissionId}
					,#{filePath}
				)
	</insert>
	
	<select id="selectAllTaskByFlag" parameterType="int" resultType="Task">
			SELECT 
				ID							AS taskId
				,TITLE                  
				,CONTENTS              
				,DEADLINE              
				,EVALUATIONPERIODSTART 
				,EVALUATIONPERIODEND    
				,FLAG                   
				,POINT                  
				FROM TASK_TB            
				WHERE FLAG = #{flag}
				ORDER BY ID ASC
	</select>
	
	<select id="selectMemberIdByTaskId" parameterType="int"  resultType="String">
			SELECT 
				MEMBERID 
				FROM TASKMEMBER 
				WHERE ASSIGNMENTID = #{taskId}
				ORDER BY ASSIGNMENTID ASC
	</select>
	
	<select id="selectAllFileList" resultType="TaskFile">
		SELECT 
			SUBMISSIONID
			,FILEPATH 
		FROM TASKFILE_TB
	</select>
	
	<select id="selectFileListByTaskId" parameterType="int" resultType="TaskFile">
		SELECT 
			SUBMISSIONID, FILEPATH 
			FROM TASKFILE_TB 
			WHERE SUBMISSIONID = #{taskId}
	</select>
	
	
	<select id="selectTaskByTaskId" parameterType="int" resultType="Task">
			SELECT 
				ID						AS taskId
				,TITLE                  
				,CONTENTS              
				,DEADLINE               
				,EVALUATIONPERIODSTART 
				,EVALUATIONPERIODEND 
				,EVALUATIONCNT   
				,FLAG                   
				,POINT                  
       			FROM TASK_TB 
			WHERE ID= #{taskId}  
	</select>
	
	<select id="selectTaskIdByMemberId" parameterType="String" resultType="int">
			SELECT 
				ASSIGNMENTID
				FROM TASKMEMBER
				WHERE MEMBERID = #{memberId}
	</select>
	
	
	<update id="updateTask" parameterType="task">
			UPDATE TASK_TB		
				SET
				ID =						#{taskId, jdbcType= INTEGER}
				,TITLE =					#{title, jdbcType= VARCHAR}
				,CONTENTS =					#{contents, jdbcType= VARCHAR}
				,DEADLINE =					#{deadline , jdbcType= VARCHAR}
				,EVALUATIONPERIODSTART =	#{evaluationPeriodStart ,jdbcType= VARCHAR}
				,EVALUATIONPERIODEND =		#{evaluationPeriodEnd ,jdbcType= VARCHAR}
			WHERE ID = #{taskId}
	</update>
	
	<update id="updateTaskPoint" parameterType="task">
			UPDATE TASK_TB
				SET POINT				= #{point, jdbcType=INTEGER}
					,EVALUATIONCNT		= #{evaluationCnt, jdbcType=INTEGER}
					
			<if test="#{evaluated}">
					,EVALUATED = 1
			</if>
			WHERE ID					= #{taskId}
	</update>
	
	<delete id="deleteTaskMember" parameterType="int">
			DELETE
			FROM TASKMEMBER 
			WHERE ASSIGNMENTID		= #{taskId}
	
	
	</delete>
	
	<delete id="deleteTask" parameterType="int">
			DELETE
			FROM TASK_TB
			WHERE ID	= #{taskId}
	</delete>
	
	<delete id="deleteTaskFile" parameterType="int">
		DELETE 
		FROM TASKFILE_TB
		WHERE SUBMISSIONID			= #{taskId}
	</delete>

	<delete id="deleteMemberIdByTaskId" >
		DELETE 
		FROM TASKMEMBER
		WHERE ASSIGNMENTID = 		#{taskId}
	</delete>	

</mapper>