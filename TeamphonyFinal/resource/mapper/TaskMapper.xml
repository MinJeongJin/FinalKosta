<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="teamphony.store.mapper.TaskMapper">

<insert id="insertAssignment" parameterType="task">
		<selectKey resultType="int" keyProperty="taskId" order="BEFORE">
			SELECT TASK_TB_ID_SEQ.NEXTVAL
			FROM DUAL
		</selectKey>
			INSERT
			INTO TASK_TB
			(
				ID,
				TITLE,
				CONTENTS,
				DEADLINE,
				FLAG,
				EVALUATIONPERIODSTART,
				EVALUATIONPERIODEND,
				POINT
			)
			VALUES
			(
				#{taskId},
				#{title},
				#{contents, jdbcType=VARCHAR},
				#{deadline, jdbcType=INTEGER},
				#{flag, jdbcType=INTEGER},
				#{evaluationPeriodStart, jdbcType=INTEGER},
				#{evaluationPeriodEnd, jdbcType=INTEGER},
				#{point, jdbcType=INTEGER}
			)
	</insert>  
	
	<insert id="insertSubmission" parameterType="task">
		<selectKey resultType="int" keyProperty="taskId" order="BEFORE">
			SELECT TASK_TB_ID_SEQ.NEXTVAL
			FROM DUAL
		</selectKey>
			INSERT
			INTO TASK_TB
			(
				ID,
				TITLE,
				CONTENTS,
				FLAG,
				POINT
			)
			VALUES
			(
				#{taskId},
				#{title},
				#{contents, jdbcType=VARCHAR},
				#{flag, jdbcType=INTEGER},
				#{point, jdbcType=INTEGER}
			)
	</insert>  
	

	<insert id="insertTaskFile" parameterType="taskFile">
			INSERT INTO
				TASKFILE_TB
				(
					SUBMISSIONID
					,FILEPATH
				)
				VALUES
				(
					#{submissionId}
					,#{filePath}
				)
	</insert>
	
	<select id="selectAllTaskByFlag" parameterType="int" resultType="Task">
			SELECT 
				ID							AS taskId,
				TITLE,                  
				CONTENTS,               
				DEADLINE,               
				EVALUATIONPERIODSTART,  
				EVALUATIONPERIODEND,    
				FLAG,                   
				POINT                  
				FROM TASK_TB            
				WHERE FLAG = #{flag}
				ORDER BY ID ASC
	</select>
	
	<select id="selectAllFileList" resultType="TaskFile">
		SELECT 
			SUBMISSIONID
			,FILEPATH 
			FROM TASKFILE_TB
	</select>
	
	<select id="selectFileListByTaskId" parameterType="int" resultType="TaskFile">
		SELECT 
			SUBMISSIONID, FILEPATH 
			FROM TASKFILE_TB 
			WHERE SUBMISSIONID = #{taskId}
	</select>
	
	
	<select id="selectTaskByTaskId" parameterType="int" resultType="Task">
			SELECT 
				ID						AS taskId,
				TITLE,                  
				CONTENTS,               
				DEADLINE,               
				EVALUATIONPERIODSTART,  
				EVALUATIONPERIODEND,    
				FLAG,                   
				POINT                  
       			FROM TASK_TB 
			WHERE ID= #{taskId}  
	</select>
	
	<update id="updateTask" parameterType="task">
			UPDATE TASK_TB		
				SET
				ID =						#{taskId, jdbcType=INTEGER}
				,TITLE =					#{title, jdbcType=VARCHAR}
				,CONTENTS =					#{contents, jdbcType=VARCHAR}
				,DEADLINE =					#{deadline , jdbcType=DATE}
				,EVALUATIONPERIODSTART =	#{evaluationPeriodStart ,jdbcType=DATE}
				,EVALUATIONPERIODEND =		#{evaluationPeriodEnd ,jdbcType=DATE}
			WHERE ID = #{taskId}
	</update>
	
	<update id="updateTaskPoint" parameterType="int">
			UPDATE TASK_TB
				SET POINT			= POINT+ #{point, jdbcType=INTEGER}
				WHERE ID			= #{taskId}
	</update>
	
	<delete id="deleteTask"  parameterType="int">
			DELETE
			FROM TASK_TB
			WHERE ID	= #{taskId}
	</delete>
	
	<delete id="deleteTaskFile" parameterType="int">
		DELETE 
		FROM TASKFILE_TB
		WHERE SUBMISSIONID			= #{taskId}
	</delete>

	<!-- <resultMap type="Task" id="taskDetail">

		<id property="taskId" column="TASK_ID" />
		<result property="title" column="TASK_TITLE" />
		<result property="contents" column="TASK_CONTENTS" />
		<result property="deadline" column="TASK_DEADLINE" />
		<result property="evaluationPeriod" column="TASK_EVALUATIONPERIOD" />
		<result property="flag" column="TASK_FLAG" />
		<result property="point" column="TASK_POINT" />
		 <collection property="taskFileList" column="TASK_ID" ofType="TaskFile" 
			select="teamphony.store.mapper.TaskMapper.selectTaskDetail" javaType="ArrayList" 
			jdbcType="NUMERIC"> </collection> 
	</resultMap>

	<select id="selectTaskDetail" resultMap="taskDetail">

		SELECT
		T.ID AS TASK_ID
		,T.TITLE AS TASK_TITLE
		,T.CONTENTS AS TASK_CONTENTS
		,T.DEADLINE AS
		TASK_DEADLINE
		,T.EVALUATIONPERIOD AS TASK_EVALUATIONPERIOD
		,T.FLAG AS
		TASK_FLAG
		,T.POINT AS TASK_POINT
		,TF.SUBMISSIONID AS
		TASKFILE_SUBMISSIONID
		,TF.FILEPATH AS TASKFILE_FILEPATH
		FROM TASK_TB T ,
		TASKFILE_TB TF
		WHERE T.ID =
		TF.SUBMISSIONID
		AND T.ID = #{taskId}

	</select>
 -->
	

</mapper>